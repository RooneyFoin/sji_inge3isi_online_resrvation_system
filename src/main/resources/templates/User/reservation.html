<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParkEase - Reserve Parking</title>
    <link rel="icon" th:href="@{/images/favicon.png}" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #1a3c8f;
            --primary-light: #2f58cd;
            --secondary-color: #95a5a6;
            --accent-color: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --background-color: #f5f7fa;
            --card-bg: #ffffff;
            --border-radius: 12px;
            --box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            --transition-speed: 0.3s;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --selected-color: #007bff;
            --hover-color: #17a2b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .bg-gradient-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
        }

        header {
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            transition: opacity 0.3s;
        }

        .nav-links a:hover {
            opacity: 0.8;
        }

        .section {
            padding: 4rem 0;
        }

        .intro-section {
            text-align: center;
            background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://images.pexels.com/photos/1756957/pexels-photo-1756957.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 6rem 0;
        }

        .intro-section h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .intro-section p {
            font-size: 1.2rem;
            max-width: 700px;
            margin: 0 auto 2rem;
        }

        .intro-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .gallery-item {
            flex: 1;
            min-width: 250px;
            max-width: 300px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            transition: transform var(--transition-speed);
        }

        .gallery-item:hover {
            transform: scale(1.05);
        }

        .gallery-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .gallery-item p {
            padding: 1rem;
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .reservation-section {
            text-align: center;
            background: white;
        }

        .reservation-section h2 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .reservation-section p {
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto 2rem;
            color: var(--text-secondary);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            position: relative;
        }

        .form-group label {
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-group select {
            padding: 0.75rem 2.5rem 0.75rem 2.5rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            background: var(--card-bg);
            appearance: none;
            transition: all var(--transition-speed);
            cursor: pointer;
            box-shadow: var(--box-shadow);
        }

        .form-group select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(26, 60, 143, 0.15);
        }

        .form-group select:hover {
            background: #f8f9fa;
        }

        .quarter-form-group::before {
            content: '\f3c5';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            left: 0.75rem;
            top: 2.5rem;
            color: var(--secondary-color);
            font-size: 1.2rem;
        }

        .quarter-form-group::after {
            content: '\f078';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 0.75rem;
            top: 2.5rem;
            color: var(--secondary-color);
            font-size: 1rem;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        .btn:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(26, 60, 143, 0.2);
        }

        .parking-lot-visual {
            margin-top: 3rem;
            text-align: center;
            background: #f8f9fa;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .parking-lot-visual h2 {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            position: relative;
            display: inline-block;
        }

        .parking-lot-visual h2::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: var(--primary-color);
            border-radius: 2px;
        }

        canvas {
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            max-width: 100%;
            background: #ffffff;
            margin: 1rem 0;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1.5rem;
            padding: 1rem;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: transform 0.3s ease;
        }

        .legend-item:hover {
            transform: translateY(-2px);
        }

        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            padding: 1.2rem 1rem;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 350px;
            width: 98%;
            position: relative;
            animation: slideIn 0.4s ease-out;
            border: 3px solid #1a3c8f;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-content h2 {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            letter-spacing: 1px;
        }

        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.8rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color var(--transition-speed);
        }

        .close-btn:hover {
            color: var(--primary-color);
        }

        .modal .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 2rem;
            position: relative;
        }

        .modal .form-group .input-wrapper {
            display: flex;
            align-items: center;
            position: relative;
        }

        .modal .form-group i {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-color);
            font-size: 1.2rem;
            z-index: 1;
        }

        .modal .form-group input,
        .modal .form-group input[type="date"],
        .modal .form-group input[type="time"],
        .modal .form-group input[type="number"] {
            padding: 0.75rem 0.75rem 0.75rem 2.5rem;
            width: 100%;
            border: 1.5px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            background: #f8f9fa;
            transition: border 0.2s;
        }

        .modal .form-group input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .modal .form-group output {
            padding: 0.75rem;
            width: 100%;
            font-weight: 500;
            color: var(--primary-color);
        }

        .modal .price-display {
            font-size: 2rem;
            font-weight: 700;
            color: #e67e22;
            background: linear-gradient(135deg, #fff3e0, #ffe8cc);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin-top: 1rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .modal .receipt {
            display: none;
            margin-top: 2rem;
            padding: 2rem 1.5rem 2.5rem 1.5rem;
            background: linear-gradient(135deg, #e6ffe6 60%, #f8fff8 100%);
            border: 3px solid var(--success-color);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px rgba(40, 167, 69, 0.13);
            position: relative;
            text-align: center;
        }

        .modal .receipt h3 {
            color: var(--success-color);
            margin-bottom: 1.2rem;
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .modal .receipt h3::before {
            content: '\f058';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: var(--success-color);
            font-size: 2rem;
            margin-right: 0.5rem;
        }

        .modal .receipt p {
            margin: 0.5rem 0;
            font-size: 1.08rem;
            color: var(--text-primary);
        }

        .modal .receipt .btn {
            margin-top: 1.5rem;
            width: 100%;
            background: linear-gradient(90deg, var(--success-color), #a8e063);
            color: #fff;
            font-weight: 600;
            font-size: 1.1rem;
            border-radius: 8px;
        }

        .modal .receipt .btn:hover {
            background: linear-gradient(90deg, #28a745, #218838);
        }

        @media (max-width: 768px) {
            .intro-section h1 {
                font-size: 2.2rem;
            }

            .reservation-section h2 {
                font-size: 2rem;
            }

            .nav-links {
                display: none;
            }

            .modal-content {
                width: 95%;
                padding: 1.5rem;
            }

            .modal .price-display {
                font-size: 1.5rem;
            }
        }

        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .parking-lot-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 2.5rem;
            justify-content: center;
            margin: 2rem 0 1rem 0;
            position: relative;
        }
        .lot-section {
            min-width: 240px;
            margin: 0 1.5rem 2rem 1.5rem;
            background: repeating-linear-gradient(135deg, #444a54 0 10px, #3a3f47 10px 20px);
            border-radius: 18px;
            box-shadow: 0 6px 24px rgba(44, 62, 80, 0.13);
            border: 3px solid #222;
            position: relative;
            padding-bottom: 1.5rem;
        }
        .lot-label {
            background: linear-gradient(90deg, #1a3c8f 60%, #2f58cd 100%);
            color: #fff;
            font-weight: 700;
            font-size: 1.2rem;
            padding: 0.7rem 1.5rem;
            border-radius: 18px 18px 0 0;
            margin-bottom: 0.5rem;
            text-align: center;
            letter-spacing: 1px;
            box-shadow: 0 2px 8px rgba(26,60,143,0.10);
            border-bottom: 2px solid #fff;
        }
        .spot-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 1.2rem;
            background: transparent;
            border-radius: 0 0 12px 12px;
            padding: 1.2rem 1rem 0.5rem 1rem;
            justify-content: center;
        }
        .parking-spot-card {
            width: 80px;
            height: 120px;
            background: linear-gradient(180deg, #e9ecef 60%, #bfc9d1 100%);
            border-radius: 14px;
            box-shadow: 0 6px 18px rgba(44, 62, 80, 0.13);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            cursor: pointer;
            transition: transform 0.18s, box-shadow 0.18s, border 0.18s;
            border: 3px solid #fff;
            position: relative;
            overflow: visible;
        }
        .parking-spot-card::before {
            content: '';
            position: absolute;
            left: 8px;
            right: 8px;
            top: 10px;
            height: 6px;
            border-radius: 3px;
            background: repeating-linear-gradient(90deg, #fff 0 8px, #f7d358 8px 16px);
            z-index: 1;
        }
        .parking-spot-card.available {
            border-color: var(--success-color);
        }
        .parking-spot-card.occupied {
            border-color: var(--danger-color);
            opacity: 0.7;
            cursor: not-allowed;
        }
        .parking-spot-card.selected {
            border-color: var(--selected-color);
            box-shadow: 0 8px 32px rgba(0,123,255,0.18);
            transform: scale(1.08);
        }
        .parking-spot-card:hover:not(.occupied) {
            box-shadow: 0 12px 36px rgba(40, 167, 69, 0.18);
            transform: translateY(-6px) scale(1.10);
        }
        .car-icon {
            margin-bottom: 0.2rem;
            margin-top: 0.7rem;
            z-index: 2;
        }
        .car-icon svg {
            width: 38px;
            height: 38px;
            display: block;
            filter: drop-shadow(0 2px 6px rgba(0,0,0,0.18));
        }
        .parking-spot-card.available .car-icon svg {
            fill: var(--success-color);
        }
        .parking-spot-card.occupied .car-icon svg {
            fill: var(--danger-color);
        }
        .parking-spot-card.selected .car-icon svg {
            fill: var(--selected-color);
        }
        .car-shadow {
            width: 32px;
            height: 8px;
            background: radial-gradient(ellipse at center, #888 0%, #fff0 100%);
            border-radius: 50%;
            margin: 0 auto 0.2rem auto;
            opacity: 0.25;
            z-index: 1;
        }
        .number-plate {
            width: 38px;
            height: 16px;
            background: #fff;
            border-radius: 4px;
            border: 1.5px solid #bbb;
            color: #333;
            font-size: 0.85rem;
            font-weight: 700;
            text-align: center;
            line-height: 16px;
            margin: 0.2rem auto 0.5rem auto;
            box-shadow: 0 1px 2px #0001;
            letter-spacing: 1px;
        }
        .parking-spot-card.occupied .number-plate {
            background: #f8d7da;
            color: #dc3545;
            border-color: #dc3545;
        }
        .parking-spot-card.selected .number-plate {
            background: #e7f1ff;
            color: #007bff;
            border-color: #007bff;
        }
        .parking-spot-card .spot-label {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-bottom: 0.1rem;
        }
        .parking-spot-card.occupied .spot-label {
            color: var(--danger-color);
        }
        .parking-spot-card.selected .spot-label {
            color: var(--selected-color);
        }
        .parking-spot-card .spot-status {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        .parking-spot-card.occupied .spot-status {
            color: var(--danger-color);
        }
        .parking-spot-card.selected .spot-status {
            color: var(--selected-color);
        }
        /* Road effect between lots */
        .parking-lot-grid::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 18px;
            background: repeating-linear-gradient(90deg, #222 0 30px, #fff0 30px 60px);
            z-index: 0;
            border-radius: 8px;
            opacity: 0.18;
        }
        /* Trees at corners */
        .tree-icon {
            position: absolute;
            width: 32px;
            height: 32px;
            z-index: 2;
        }
        .tree-icon.left-top { left: -18px; top: -18px; }
        .tree-icon.right-top { right: -18px; top: -18px; }
        .tree-icon.left-bottom { left: -18px; bottom: -18px; }
        .tree-icon.right-bottom { right: -18px; bottom: -18px; }
        .tree-icon svg {
            width: 100%; height: 100%;
        }
        .spot-count {
            background: #f0f0f0;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.9em;
            color: black;
        }
        .spot-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 0.5rem;
        }
        /*.location-container {*/
        /*    margin-bottom: 3rem;*/
        /*    padding: 1.5rem;*/
        /*    background: #f9f9f9;*/
        /*    border-radius: 8px;*/
        /*    box-shadow: 0 2px 4px rgba(0,0,0,0.1);*/
        /*}*/

        .location-header {
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #eee;
        }
        /*.lot-header h3 {*/
        /*    color: white;*/
        /*}*/

        /*.trees-container {*/
        /*    position: relative;*/
        /*    min-height: 50px;*/
        /*    margin-bottom: 1rem;*/
        /*}*/
    </style>
</head>
<body>
<header class="bg-gradient-primary">
    <div class="container">
        <nav>
            <div class="logo">
                <i class="fas fa-parking"></i>
                <span>ParkEase</span>
            </div>
            <div class="nav-links">
                <a th:href="@{/history/{userId}(userId=${userId})}">History</a>
                <a href="/logout">Logout</a>
                <span th:text="${user.name}"></span>
                <i class="fa-solid fa-circle-user logo"></i>
            </div>
    </div>
</header>

<section class="intro-section">
    <div class="container">
        <h1 class="fade-in">Reserve your parking space</h1>
        <p class="fade-in">Discover Stress-Free Parking in Yaoundé</p>
        <div class="intro-gallery fade-in">
            <div class="gallery-item">
                <img th:src="@{/images/mvan-parking.webp}" alt="Bastos Parking">
                <p>Secure parking in the heart of Bastos, perfect for business and leisure.</p>
            </div>
            <div class="gallery-item">
                <img th:src="@{/images/orig.jpeg}" alt="Etoa-Meki Parking">
                <p>Convenient spots in Etoa-Meki, close to local markets and amenities.</p>
            </div>
            <div class="gallery-item">
                <img th:src="@{/images/Student Parking-Simple.jpg}" alt="Mvan Parking">
                <p>Spacious parking in Mvan, ideal for commuters and visitors.</p>
            </div>
        </div>
    </div>
</section>

<section class="reservation-section">
    <div class="container">
        <h2 class="fade-in">Reserve Your Parking Space</h2>
        <p class="fade-in">Select a quarter and parking spot, then reserve your space with ease.</p>

        <div class="form-group quarter-form-group fade-in">
            <label for="quarter-select">Select Quarter</label>
            <select id="quarter-select" class="form-control">
                <option value="">-- Select Quarter --</option>
                <!-- Options will be added dynamically -->
            </select>
        </div>

        <div id="before-select" style="display: block">
            <h2 style="font-size: large; margin-bottom: 50px">
                Please choose a location first.
            </h2>
        </div>


        <div class="parking-lot-visual" id="parking-visual" style="display: none;">
            <h2>Available Parking Spots</h2>
            <div class="parking-lot-grid" id="parking-lot-grid"></div>
            <div class="legend">
                <div class="legend-item">
                    <span class="legend-color" style="background: var(--success-color);"></span>
                    <span>Available</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: var(--danger-color);"></span>
                    <span>Occupied</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: var(--selected-color);"></span>
                    <span>Selected</span>
                </div>
            </div>
            <button class="btn" id="reserve-btn" style="margin-top: 1.5rem;" disabled>Reserve Selected Spot</button>
        </div>
    </div>
</section>

<div class="modal" id="reservation-modal">
    <div class="modal-content">
        <span class="close-btn">×</span>
        <h2><i class="fas fa-parking"></i> Reserve Parking Spot</h2>
        <form id="reservation-form">
            <div class="form-group">
                <label for="start-date">Start Date</label>
                <div class="input-wrapper">
                    <i class="fas fa-calendar-alt"></i>
                    <input type="date" id="start-date" required>
                </div>
            </div>
            <div class="form-group">
                <label for="start-time">Start Time</label>
                <div class="input-wrapper">
                    <i class="fas fa-clock"></i>
                    <input type="time" id="start-time" required>
                </div>
            </div>
            <div class="form-group">
                <label for="hours">Number of Hours</label>
                <div class="input-wrapper">
                    <i class="fas fa-clock"></i>
                    <input type="number" id="hours" min="1" required placeholder="e.g., 2">
                </div>
            </div>
            <div class="form-group">
                <label>End Date & Time</label>
                <div class="input-wrapper">
                    <output id="end-date">Select start date and hours</output>
                </div>
            </div>
            <div class="form-group">
                <label>Total Price (<span th:text="${price}"> </span>/hour)</label>
                <div class="input-wrapper">
                    <output id="total-price" class="price-display">0 FCFA</output>
                </div>
            </div>
            <button type="submit" class="btn"><i class="fas fa-check-circle"></i> Confirm Reservation</button>
        </form>
        <div class="receipt" id="receipt">
            <h3>Reservation Confirmed!</h3>
            <p><strong>Name:</strong> <span id="receipt-name"></span></p>
            <p><strong>Quarter:</strong> <span id="receipt-quarter"></span></p>
            <p><strong>Lot & Spot:</strong> <span id="receipt-lot-spot"></span></p>
            <p><strong>Start Date:</strong> <span id="receipt-start-date"></span></p>
            <p><strong>Start Time:</strong> <span id="receipt-start-time"></span></p>
            <p><strong>End Date & Time:</strong> <span id="receipt-end"></span></p>
            <p><strong>Total Price:</strong> <span id="receipt-price"></span></p>
            <button class="btn" id="close-receipt">Close</button>
        </div>
    </div>
</div>
<script th:inline="javascript">
    /*<![CDATA[*/
    // Extract everything from the user object
    const user = /*[[${user}]]*/ {};
    const userId = user?.id || 0; // Derive from user object

    // Debug log
    console.log("User object:", user);
    console.log("Derived userId:", userId);
    /*]]>*/
</script>
<script>
    // To Prevent selecting a future date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('start-date').setAttribute('min', today);

    const parkingLotGrid = document.getElementById('parking-lot-grid');
    const beforeSelect = document.getElementById('before-select');
    let allLocationDtos = [];
    let reservationDto = {};

    function initialize() {
        fetch("/get-all-parkingSpots", {
            method: "GET",
            credentials: "include", // Send cookies (for session auth)
            headers: {
                "Accept": "application/json", // Force JSON response
                // "Authorization": "Bearer YOUR_JWT_TOKEN" // If using JWT
            }
        })
            .then(response => response.json())
            .then(locationDtos => {
                allLocationDtos = locationDtos;
                renderParkingLocations(locationDtos);
                populateLocationDropdown(locationDtos);
            })
            .catch(error => {
            console.error('Error loading parking data:', error);
            // Show error state
        });
    }

    async function createReservation(reservationDto) {
        try {
            console.log("Request payload:", JSON.stringify(reservationDto, null, 2));
            if (!userId || typeof userId !== 'number') {
                alert("Invalid user session. Please reload.");
                return;
            }
            const response = await fetch(`/add-reservation/${userId}`, {
                method: 'POST',
                credentials: "include",
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(reservationDto)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            markSpotAsReserved(reservationDto.parkingSpot.parkingSpotId);

            return await response.json();
        } catch (error) {
            console.error('Error creating reservation:', error);
            throw error; // Re-throw for further handling
        }
    }
    // --- Modern Grid-Based Parking Lot Visualization ---

    let selectedSpot = null;

    const quarterSelect = document.getElementById('quarter-select');
    const parkingVisual = document.getElementById('parking-visual');
    const reserveBtn = document.getElementById('reserve-btn');

    function markSpotAsReserved(parkingSpotId){
        allLocationDtos.forEach(location => {
            location.parkingLots?.forEach(lot => {
                lot.parkingSpots?.forEach(spot => {
                    if (spot.parkingSpotId === parkingSpotId){
                        spot.parkingSpotStatus = "Occupied";
                        selectedSpot = null;
                    }
                });
            });
        });
        const locationDtos = [];
        const selectedLocationDto = allLocationDtos.find(location =>
            location.locationName.toLowerCase() === quarterSelect.value.toLowerCase()
        );
        locationDtos.push(selectedLocationDto)
        renderParkingLocations(locationDtos);
    }

    function renderParkingLocations(locationDtos) {
        // Clear the existing grid
        parkingLotGrid.innerHTML = '';

        // Process each location
        locationDtos.forEach(locationDto => {
            // Create location container
            const locationContainer = document.createElement('div');
            locationContainer.className = 'location-container';

            // Add location header
            const locationHeader = document.createElement('div');
            locationHeader.className = 'location-header';
            locationHeader.innerHTML = `<h2>${locationDto.locationName}</h2>`;
            locationContainer.appendChild(locationHeader);

            // Add decorative trees for this location (optional)
            const treesContainer = document.createElement('div');
            treesContainer.className = 'trees-container';
            [
                { cls: 'left-top', x: 0, y: 0 },
                { cls: 'right-top', x: 1, y: 0 },
                { cls: 'left-bottom', x: 0, y: 1 },
                { cls: 'right-bottom', x: 1, y: 1 }
            ].forEach(tree => {
                const treeDiv = document.createElement('div');
                treeDiv.className = `tree-icon ${tree.cls}`;
                treeDiv.innerHTML = `<svg viewBox="0 0 32 32"><circle cx="16" cy="16" r="13" fill="#3ec46d" stroke="#228b22" stroke-width="3"/><rect x="13" y="22" width="6" height="8" rx="2" fill="#8d6748"/></svg>`;
                treesContainer.appendChild(treeDiv);
            });
            locationContainer.appendChild(treesContainer);

            // Process each parking lot in the location
            console.log(locationDto.parkingLots);
            console.log(locationDto)
            locationDto.parkingLots.forEach(parkingLot => {
                const lotSection = document.createElement('div');
                lotSection.className = 'lot-section';

                // Add parking lot header
                const lotHeader = document.createElement('div');
                lotHeader.className = 'lot-label';
                lotHeader.innerHTML = `
                <h3>${parkingLot.parkingLotID}</h3>
                <span class="spot-count">${parkingLot.parkingSpots.filter(spot => spot.parkingSpotStatus === 'Available').length}/${parkingLot.totalSpots} available</span>
            `;
                lotSection.appendChild(lotHeader);

                // Create grid for parking spots
                const spotGrid = document.createElement('div');
                spotGrid.className = 'spot-grid';

                // Add each parking spot
                parkingLot.parkingSpots.forEach(spot => {
                    const spotCard = document.createElement('div');
                    const isAvailable = spot.parkingSpotStatus === 'Available';

                    spotCard.className = `parking-spot-card ${isAvailable ? 'available' : 'occupied'}`;
                    if (selectedSpot && selectedSpot.parkingSpotId === spot.parkingSpotId) {
                        spotCard.classList.add('selected');
                    }

                    spotCard.innerHTML = `
                    <div class="car-icon">
                        <span class="car-shadow"></span>
                        <svg viewBox="0 0 40 40"><rect x="8" y="10" width="24" height="18" rx="5" fill="currentColor"/><rect x="12" y="14" width="16" height="10" rx="2" fill="#fff"/><circle cx="14" cy="30" r="3" fill="#222"/><circle cx="26" cy="30" r="3" fill="#222"/></svg>
                    </div>
                    <div class="spot-info">
                        <span class="spot-id">${spot.parkingSpotId}</span>
                        <span class="spot-status">${spot.parkingSpotStatus.toLowerCase()}</span>
                    </div>
                `;

                    if (isAvailable) {
                        spotCard.addEventListener('click', (event) => {
                            event.stopPropagation(); // Prevent event from bubbling to document

                            // Toggle selection
                            if (selectedSpot && selectedSpot.parkingSpotId === spot.parkingSpotId) {
                                // Clicked the already selected spot -> unselect
                                selectedSpot = null;
                                reserveBtn.disabled = true;
                            } else {
                                // Select new spot
                                selectedSpot = {
                                    ...spot,
                                    locationId: locationDto.locationID,
                                    parkingLotId: parkingLot.parkingLotID
                                };
                                reserveBtn.disabled = false;
                            }

                            // Re-render to update UI
                            renderParkingLocations(locationDtos);
                        });
                    }

                    spotGrid.appendChild(spotCard);
                });

                lotSection.appendChild(spotGrid);
                locationContainer.appendChild(lotSection);
            });

            parkingLotGrid.appendChild(locationContainer);
        });
    }

    // Function to populate the location dropdown
    function populateLocationDropdown(locationDtos) {
        const quarterSelect = document.getElementById('quarter-select');

        // Clear existing options except the first one
        while (quarterSelect.options.length > 1) {
            quarterSelect.remove(1);
        }

        // Add new options from locationDtos
        locationDtos.forEach(location => {
            const option = document.createElement('option');
            option.value = location.locationName.toLowerCase().replace(/\s+/g, '-');
            option.textContent = location.locationName;
            quarterSelect.appendChild(option);
        });
    }

    quarterSelect.addEventListener('change', () => {
        const selectedLocationValue = quarterSelect.value;

        if (selectedLocationValue) {
            beforeSelect.style.display = 'none';
            parkingVisual.style.display = 'block';

            // Find the matching location in our stored DTOs
            const selectedLocation = allLocationDtos.find(loc =>
                loc.locationName.toLowerCase().replace(/\s+/g, '-') === selectedLocationValue
            );

            if (selectedLocation) {
                renderParkingLocations([selectedLocation]); // Render just this location
            }

            selectedSpot = null;
            reserveBtn.disabled = true;
        } else {
            parkingVisual.style.display = 'none';
            beforeSelect.style.display = 'block';
            reserveBtn.disabled = true;
        }
    });

    // --- Reservation modal logic (unchanged) ---
    const modal = document.getElementById('reservation-modal');
    const closeBtn = document.querySelector('.close-btn');
    const reservationForm = document.getElementById('reservation-form');
    const startDateInput = document.getElementById('start-date');
    const startTimeInput = document.getElementById('start-time');
    const hoursInput = document.getElementById('hours');
    const endDateOutput = document.getElementById('end-date');
    const totalPriceOutput = document.getElementById('total-price');
    const receipt = document.getElementById('receipt');
    const receiptName = document.getElementById('receipt-name');
    const receiptQuarter = document.getElementById('receipt-quarter');
    const receiptLotSpot = document.getElementById('receipt-lot-spot');
    const receiptStartDate = document.getElementById('receipt-start-date');
    const receiptStartTime = document.getElementById('receipt-start-time');
    const receiptEnd = document.getElementById('receipt-end');
    const receiptPrice = document.getElementById('receipt-price');
    const closeReceiptBtn = document.getElementById('close-receipt');

    reserveBtn.addEventListener('click', () => {
        if (selectedSpot) {
            modal.style.display = 'flex';
        }
    });

    closeBtn.addEventListener('click', () => {
        modal.style.display = 'none';
        reservationForm.style.display = 'block';
        receipt.style.display = 'none';
        reservationForm.reset();
        endDateOutput.textContent = 'Select start date and hours';
        totalPriceOutput.textContent = '0 FCFA';
    });

    function updateReservationDetails() {
        const date = startDateInput.value;
        const time = startTimeInput.value;
        const hours = parseInt(hoursInput.value) || 0;
        if (date && time && hours > 0) {
            const startDateTime = new Date(date + 'T' + time);
            const endDate = new Date(startDateTime.getTime() + hours * 60 * 60 * 1000);
            endDateOutput.textContent = endDate.toLocaleString();
            const price = hours * 100;
            totalPriceOutput.textContent = `${price} FCFA`;
        } else {
            endDateOutput.textContent = 'Select start date and hours';
            totalPriceOutput.textContent = '0 FCFA';
        }
    }

    startDateInput.addEventListener('input', updateReservationDetails);
    startTimeInput.addEventListener('input', updateReservationDetails);
    hoursInput.addEventListener('input', updateReservationDetails);

    reservationForm.addEventListener('submit', (e) => {
        e.preventDefault();
        // const name = document.getElementById('name').value;
        const date = startDateInput.value;
        const time = startTimeInput.value;
        const hours = parseInt(hoursInput.value);
        const startDateTime = new Date(date + 'T' + time);
        const endDate = new Date(startDateTime.getTime() + hours * 60 * 60 * 1000);
        const price = hours * 100;

        // Convert JavaScript Date to "YYYY-MM-DD" (LocalDate format) which is required by the api
        function formatLocalDate(dateInput) {
            // Handle string dates (e.g., from date pickers)
            if (typeof dateInput === 'string') {
                return dateInput.split('T')[0]; // Already in ISO format
            }

            // Handle Date objects
            if (dateInput instanceof Date && !isNaN(dateInput)) {
                return dateInput.toISOString().split('T')[0];
            }

            // Handle Moment.js/Luxon objects
            if (dateInput?.toISOString) {
                return dateInput.toISOString().split('T')[0];
            }

            throw new Error(`Invalid date: ${dateInput}`);
        }

        function formatLocalTime(timeInput) {
            // Already formatted time string
            if (typeof timeInput === 'string') {
                if (/^\d{2}:\d{2}(:\d{2})?$/.test(timeInput)) {
                    return timeInput.length === 5 ? `${timeInput}:00` : timeInput;
                }
            }

            // Handle Date objects
            if (timeInput instanceof Date) {
                return timeInput.toLocaleTimeString('en-US', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }

            throw new Error(`Invalid time: ${timeInput}`);
        }

        reservationDto = {
            "reservationStartDate": formatLocalDate(date),
            "reservationEndDate": formatLocalDate(endDate),
            "startTime": formatLocalTime(time),
            "endTime": formatLocalTime(endDate),
            "duration": hours,
            "cost": price,
            "parkingSpot": {
                "parkingSpotId": selectedSpot.parkingSpotId,
            }
        };

        reservationForm.style.display = 'none';
        receipt.style.display = 'block';
        receiptName.textContent = user.name;
        receiptQuarter.textContent = quarterSelect.value;
        const locationDtos = [];
        const selectedLocationDto = allLocationDtos.find(location =>
            location.locationName.toLowerCase() === quarterSelect.value.toLowerCase()
        );
        locationDtos.push(selectedLocationDto)
        receiptLotSpot.textContent = `${selectedSpot.parkingLotId} - ${selectedSpot.parkingSpotId}`;
        receiptStartDate.textContent = startDateTime.toLocaleDateString();
        receiptStartTime.textContent = startDateTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        receiptEnd.textContent = endDate.toLocaleString();
        receiptPrice.textContent = `${price} FCFA`;
        selectedSpot.available = false;
        renderParkingLocations(locationDtos);

        // Store the dynamically calculated price (in FCFA) for use in stripe.html
        const price2 = price/100;
        sessionStorage.setItem("reservationPrice", price2);
        createReservation(reservationDto);
    });

    closeReceiptBtn.addEventListener('click', () => {
        modal.style.display = 'none';
        reservationForm.style.display = 'block';
        receipt.style.display = 'none';
        reservationForm.reset();
        endDateOutput.textContent = 'Select start date and hours';
        totalPriceOutput.textContent = '0 FCFA';
        selectedSpot = null;
        reserveBtn.disabled = true;
    });

    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
            reservationForm.style.display = 'block';
            receipt.style.display = 'none';
            reservationForm.reset();
            endDateOutput.textContent = 'Select start date and hours';
            totalPriceOutput.textContent = '0 FCFA';
        }
    });
    document.addEventListener("DOMContentLoaded", function() {
        const form = document.getElementById("reservation-form");

        form.addEventListener("submit", function(event) {
            event.preventDefault(); // Prevent actual form submission

            // Redirect to /checkout
            window.location.href = `/checkout/${userId}`;
        });
    });

    document.addEventListener('DOMContentLoaded', initialize);
</script>
</body>
</html>